# comma-tools MCP Server

> **⚠️ FOR AI ASSISTANTS** - This MCP server is designed for AI assistants (like Claude, ChatGPT, etc.) to programmatically access comma-tools analysis capabilities. **If you are a human user**, you probably want to use `cts` CLI or `cts-lite` API directly instead. See the [main README](../../README.md) for human-friendly usage.

Model Context Protocol (MCP) server that exposes the comma-tools CTS-Lite API to AI assistants, enabling natural language interaction with openpilot log analysis, run management, and artifact access.

## For AI Assistants: Self-Registration Instructions

**If you are an AI assistant (like Claude Code)**, follow these steps to register this MCP server and gain access to comma-tools analysis capabilities:

### Prerequisites Check

First, verify the CTS-Lite API server is running:

```bash
curl http://127.0.0.1:8080/v1/health
```

Expected response: `{"status": "healthy", ...}`

If not running, the human user needs to start it: `cts-lite`

### Claude Code: Self-Registration Steps

**If you are Claude Code**, you can register yourself to use these tools:

1. **Verify the command exists:**
   ```bash
   # Find the cts-mcp command in the project's venv
   find . -name cts-mcp -path "*/venv/bin/*" | head -1
   ```

2. **Register the MCP server to yourself:**
   ```bash
   # Use the full path you found above
   claude mcp add comma-tools --scope user \
     -e CTS_LITE_URL=http://127.0.0.1:8080 \
     -- /path/to/comma-tools/venv/bin/cts-mcp
   ```

3. **Verify connection:**
   ```bash
   claude mcp list
   ```

   You should see: `comma-tools: /path/to/cts-mcp - ✓ Connected`

4. **You now have access to these tools:**
   - `check_health()` - Verify CTS-Lite is running
   - `get_version()` - Check API version compatibility
   - `list_capabilities()` - See available analysis tools
   - `run_analysis()` - Start log analysis runs
   - `get_run_status()` - Monitor run progress
   - `list_runs()` - View recent analysis runs
   - `list_artifacts()` - List generated artifacts
   - `get_artifact_content()` - Read text artifacts
   - `download_artifact()` - Save artifacts to disk

### Other AI Assistants: Integration Methods

**Claude Desktop App**: Add to `~/Library/Application Support/Claude/claude_desktop_config.json`:
```json
{
  "mcpServers": {
    "comma-tools": {
      "command": "cts-mcp",
      "env": {"CTS_LITE_URL": "http://127.0.0.1:8080"}
    }
  }
}
```

**ChatGPT** (via MCP client): Use the MCP client library to connect programmatically.

**Custom Integration**: Use the MCP Python SDK to connect via stdio transport.

## Available Tools

### Health & Discovery
- **check_health()** → `{"status": "healthy", "version": "0.8.0", ...}`
- **get_version()** → `{"api_version": "0.1.0", "min_client_version": "0.8.0", ...}`
- **list_capabilities()** → List of available analysis tools with parameters

### Analysis Execution
- **run_analysis(tool_id, parameters, name?)** → Start an analysis run
  - Example: `run_analysis("rlog-to-csv", {"rlog": "/path/to/file.zst", "out": "/tmp/output.csv"})`
  - Returns: `{"run_id": "...", "status": "queued", ...}`

### Run Management
- **get_run_status(run_id)** → Current status, progress, artifacts
- **list_runs(status?, limit?)** → Recent runs with optional filtering

### Artifact Access
- **list_artifacts(run_id)** → All files generated by a run
- **get_artifact_content(artifact_id, max_size?)** → Read text content (CSV, JSON, HTML)
- **download_artifact(artifact_id, output_path)** → Save artifact to disk

### Resources
- **cts://config** - Server configuration and status
- **cts://capabilities** - Summary of available tools

## Example AI Assistant Workflows

Once registered, you (as an AI assistant) can help users with natural language requests:

**User**: "Check if CTS-Lite is healthy"
```python
check_health()
# Returns: {"status": "healthy", "version": "0.8.0", "uptime": "0d 2h 15m 30s"}
```

**User**: "What analysis tools are available?"
```python
caps = list_capabilities()
# Shows: rlog-to-csv, can-bitwatch, cruise-control-analyzer, etc.
```

**User**: "Analyze this log file: tests/data/known_good.rlog.zst"
```python
# Start analysis
result = run_analysis("rlog-to-csv", {
    "rlog": "tests/data/known_good.rlog.zst",
    "out": "/tmp/analysis.csv"
})

# Monitor progress
status = get_run_status(result["run_id"])

# Get artifacts when complete
artifacts = list_artifacts(result["run_id"])
```

**User**: "Download the CSV from that last run"
```python
artifacts = list_artifacts(run_id)
csv_artifact = [a for a in artifacts if a["filename"].endswith(".csv")][0]
download_artifact(csv_artifact["id"], "/tmp/downloaded_analysis.csv")
```

## Architecture

```
Human User
    ↓ Natural Language
AI Assistant (You)
    ↓ MCP Protocol
comma-tools MCP Server (this)
    ↓ HTTP/REST
CTS-Lite API Server
    ↓ Direct Execution
Analysis Tools (rlog-to-csv, can-bitwatch, etc.)
    ↓ Processing
openpilot Log Files
```

## For Human Users

**If you are a human user**, you don't need this MCP server. The MCP server is a bridge that lets AI assistants use comma-tools on your behalf.

**Instead, use:**
- **CLI**: `cts run rlog-to-csv --path your-log.zst --wait`
- **API**: `curl -X POST http://127.0.0.1:8080/v1/runs -d '{"tool_id": "rlog-to-csv", ...}'`
- **Direct**: `rlog-to-csv your-log.zst`

See the [main README](../../README.md) for human-friendly documentation.

## Installation (For Developers)

```bash
# Install comma-tools with MCP support
pip install -e ".[mcp]"
```

## Testing the Server (For Developers)

```bash
# Ensure CTS-Lite is running
cts-lite &

# Test MCP server tools directly
python -c "
from comma_tools_mcp.server import check_health, list_capabilities
import json
print(json.dumps(check_health(), indent=2))
"
```

### With MCP Inspector (Development)

```bash
pip install mcp-inspector
mcp dev src/comma_tools_mcp/server.py
```

## Environment Variables

- `CTS_LITE_URL` - URL of the CTS-Lite API server (default: `http://127.0.0.1:8080`)

## Troubleshooting

### For AI Assistants

**"Failed to connect" error:**
1. Verify CTS-Lite is running: `curl http://127.0.0.1:8080/v1/health`
2. Check the `cts-mcp` path is correct: `which cts-mcp` or find it in venv
3. Re-register with absolute path: `claude mcp add comma-tools ... -- /full/path/to/cts-mcp`

**Tools not appearing:**
- Run `claude mcp list` to verify "✓ Connected" status
- Restart your AI assistant application if needed

### For Developers

**Server not starting:**
- CTS-Lite must be running first: `cts-lite`
- Check dependencies: `pip install -e ".[mcp]"`

**Connection refused:**
- Verify CTS-Lite port: `curl http://127.0.0.1:8080/v1/health`
- Check firewall settings
- Verify `CTS_LITE_URL` environment variable

## Development

### Adding New Tools

```python
@mcp.tool()
def my_new_tool(param: str) -> Dict[str, Any]:
    """
    Description for AI assistants to understand when to use this tool.

    Args:
        param: Parameter description

    Returns:
        Return value description
    """
    return make_request("GET", f"/v1/my-endpoint/{param}")
```

### Testing Individual Tools

```python
from comma_tools_mcp.server import check_health
result = check_health()
assert result["status"] == "healthy"
```

## Future Enhancements

- [ ] Streaming support for long-running analyses
- [ ] Webhook notifications for run completion
- [ ] Batch analysis operations
- [ ] Integration with ChatGPT MCP for multi-AI workflows
- [ ] Progress reporting during analysis execution